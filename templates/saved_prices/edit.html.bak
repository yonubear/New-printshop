{% extends 'layout.html' %}

{% block title %}Edit Price{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle materials section visibility based on template checkbox
        const templateCheckbox = document.getElementById('is_template');
        const materialsSection = document.getElementById('materials_section');
        
        if (templateCheckbox && materialsSection) {
            templateCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    materialsSection.classList.remove('d-none');
                } else {
                    materialsSection.classList.add('d-none');
                }
            });
        }
        
        // Direct method to add material without complex dynamic creation
        document.addEventListener('click', function(event) {
            // Check if clicked element has the add-material class
            if (event.target.closest('.add-material')) {
                console.log('Add material button clicked');
                addMaterialSimple();
            }
        });
        
        // Simple function to add material row by cloning a template
        function addMaterialSimple() {
            console.log("Adding material row using simple method");
            // Get the template from the page
            const template = document.getElementById('material-row-template');
            
            if (!template) {
                // Create template on the fly if it doesn't exist
                createMaterialTemplate();
                addMaterialSimple(); // Try again after creating template
                return;
            }
            
            // Get the container
            const container = document.querySelector('.materials-container');
            if (!container) {
                console.error("Material container not found");
                alert("Could not find material container. Please refresh the page.");
                return;
            }
            
            // Clone the template
            const clone = template.content.cloneNode(true);
            
            // Add event listener to remove button
            const removeBtn = clone.querySelector('.remove-material');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    this.closest('.material-row').remove();
                });
            }
            
            // Add the clone to the container
            container.appendChild(clone);
            
            console.log("Added new material row");
        }
        
        // Create a template for material rows if none exists
        function createMaterialTemplate() {
            console.log("Creating material row template");
            
            // Check if the template already exists
            if (document.getElementById('material-row-template')) {
                return;
            }
            
            // Create a template element
            const template = document.createElement('template');
            template.id = 'material-row-template';
            
            // Set template content
            template.innerHTML = `
                <div class="material-row mb-3 pb-3 border-bottom">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-2">
                                <label class="form-label">Material Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="material_names[]" placeholder="e.g., Premium Paper">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-2">
                                <label class="form-label">Category</label>
                                <select class="form-select" name="material_categories[]">
                                    <option value="paper">Paper</option>
                                    <option value="ink">Ink</option>
                                    <option value="substrate">Substrate</option>
                                    <option value="laminate">Laminate</option>
                                    <option value="binding">Binding</option>
                                    <option value="other" selected>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-2">
                                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="material_quantities[]" min="0" step="0.01" value="1">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-2">
                                <label class="form-label">Unit</label>
                                <select class="form-select" name="material_units[]">
                                    <option value="pcs">Piece(s)</option>
                                    <option value="sheets">Sheet(s)</option>
                                    <option value="sqft">Sq. Foot</option>
                                    <option value="yards">Yard(s)</option>
                                    <option value="meters">Meter(s)</option>
                                    <option value="liters">Liter(s)</option>
                                    <option value="gallons">Gallon(s)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-2">
                                <label class="form-label">Cost Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="material_costs[]" min="0" step="0.01" value="0.00">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <div class="mb-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-outline-danger d-block remove-material">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-2">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="material_notes[]" rows="1" placeholder="Optional notes about this material"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add the template to the document
            document.body.appendChild(template);
            console.log("Material row template created");
        }
        
        // Add functionality to create a material row from an existing material
        function addExistingMaterial(material) {
            console.log("Adding existing material:", material);
            
            // Create a completely new material row rather than cloning
            const newRow = document.createElement('div');
            newRow.className = 'material-row mb-3 pb-3 border-bottom';
            
            // Create HTML structure
            newRow.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-2">
                            <label class="form-label">Material Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="material_names[]" value="${material.name}" placeholder="e.g., Premium Paper">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="material_categories[]">
                                <option value="paper">Paper</option>
                                <option value="ink">Ink</option>
                                <option value="substrate">Substrate</option>
                                <option value="laminate">Laminate</option>
                                <option value="binding">Binding</option>
                                <option value="other" selected>Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <label class="form-label">Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="material_quantities[]" min="0" step="0.01" value="1">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <label class="form-label">Unit</label>
                            <select class="form-select" name="material_units[]">
                                <option value="pcs">Piece(s)</option>
                                <option value="sheets">Sheet(s)</option>
                                <option value="sqft">Sq. Foot</option>
                                <option value="yards">Yard(s)</option>
                                <option value="meters">Meter(s)</option>
                                <option value="liters">Liter(s)</option>
                                <option value="gallons">Gallon(s)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <label class="form-label">Cost Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="material_costs[]" min="0" step="0.01" value="${material.cost_price || 0}">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="mb-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-danger d-block remove-material">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="mb-2">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" name="material_notes[]" rows="1" placeholder="Optional notes about this material">${material.description || ''}</textarea>
                        </div>
                    </div>
                </div>
            `;
            
            // Add remove functionality
            const removeBtn = newRow.querySelector('.remove-material');
            removeBtn.addEventListener('click', function() {
                newRow.remove();
            });
            
            // Set category if it matches one of our options
            const categorySelect = newRow.querySelector('select[name="material_categories[]"]');
            const category = getMaterialCategory(material);
            for (let i = 0; i < categorySelect.options.length; i++) {
                if (categorySelect.options[i].value === category) {
                    categorySelect.selectedIndex = i;
                    break;
                }
            }
            
            // Set unit if available
            const unitSelect = newRow.querySelector('select[name="material_units[]"]');
            if (material.unit) {
                for (let i = 0; i < unitSelect.options.length; i++) {
                    // Handle singular/plural variations
                    const optionValue = unitSelect.options[i].value;
                    if (optionValue === material.unit || 
                        (optionValue === 'sheets' && material.unit === 'sheet') ||
                        (optionValue === 'pcs' && material.unit === 'each')) {
                        unitSelect.selectedIndex = i;
                        break;
                    }
                }
            }
            
            // Add to container
            const materialsContainer = document.querySelector('.materials-container');
            materialsContainer.appendChild(newRow);
            console.log("Added new material row to container");
            
            // Close the modal
            const modal = document.getElementById('existingMaterialsModal');
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
                console.log("Modal closed");
            }
        }
        
        // Helper function to determine category from material data
        function getMaterialCategory(material) {
            // Default to 'other' if no category can be determined
            let category = 'other';
            
            // Try to determine from name or description
            const name = material.name.toLowerCase();
            const desc = material.description ? material.description.toLowerCase() : '';
            
            if (name.includes('paper') || desc.includes('paper') || 
                name.includes('cardstock') || desc.includes('cardstock')) {
                category = 'paper';
            } else if (name.includes('ink') || desc.includes('ink')) {
                category = 'ink';
            } else if (name.includes('laminate') || desc.includes('laminate')) {
                category = 'laminate';
            } else if (name.includes('binding') || desc.includes('binding')) {
                category = 'binding';
            } else if (name.includes('substrate') || desc.includes('substrate')) {
                category = 'substrate';
            }
            
            return category;
        }
        
        // Remove material row functionality
        document.querySelectorAll('.remove-material').forEach(btn => {
            btn.addEventListener('click', function() {
                // Only remove if there's more than one material row
                const materialRows = document.querySelectorAll('.material-row');
                if (materialRows.length > 1) {
                    this.closest('.material-row').remove();
                } else {
                    // Clear values instead of removing the only row
                    const row = this.closest('.material-row');
                    row.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
                        if (input.name === 'material_quantities[]') {
                            input.value = '1';
                        } else if (input.name === 'material_costs[]') {
                            input.value = '0.00';
                        } else {
                            input.value = '';
                        }
                    });
                    
                    // Reset selects
                    row.querySelectorAll('select').forEach(select => {
                        select.selectedIndex = 0;
                    });
                }
            });
        });
        
        // Existing Materials Modal
        const materialsModal = document.getElementById('existingMaterialsModal');
        console.log("Modal element found:", materialsModal);
        if (materialsModal) {
            materialsModal.addEventListener('show.bs.modal', function (event) {
                console.log("Modal show event triggered");
                // Load materials when the modal is shown
                loadMaterials();
            });
            
            // Search functionality
            const searchInput = document.getElementById('materialSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const items = document.querySelectorAll('#materialsListContainer .list-group-item');
                    
                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });
            }
        }
        
        // Function to load materials from API
        function loadMaterials() {
            console.log("loadMaterials function called");
            const container = document.getElementById('materialsListContainer');
            console.log("Materials container:", container);
            if (!container) {
                console.error("Could not find materials list container!");
                return;
            }
            
            // Clear previous content
            container.innerHTML = '';
            console.log("Cleared container content");
            
            // Show loading indicator
            const loadingSpinner = document.querySelector('#existingMaterialsModal .spinner-border');
            const loadingText = document.querySelector('#existingMaterialsModal p.text-muted');
            
            console.log("Loading spinner:", loadingSpinner);
            console.log("Loading text:", loadingText);
            
            if (loadingSpinner) loadingSpinner.style.display = 'block';
            if (loadingText) loadingText.style.display = 'block';
            
            console.log("Set up sample materials loading");
            
            // Create materials immediately rather than with timeout
            // Create sample materials
            const materials = [
                {
                    id: 1,
                    name: "Premium Gloss Paper",
                    description: "High quality gloss paper for premium prints",
                    sku: "PAPER-001",
                    price: 0.25,
                    cost_price: 0.15,
                    unit: "sheet"
                },
                {
                    id: 2,
                    name: "Black Ink Cartridge",
                    description: "Standard black ink for laser printers",
                    sku: "INK-001",
                    price: 35.00,
                    cost_price: 22.50,
                    unit: "each"
                },
                {
                    id: 3,
                    name: "Binding Coil - 12mm",
                    description: "12mm black plastic binding coil",
                    sku: "BIND-001",
                    price: 2.50,
                    cost_price: 1.25,
                    unit: "each"
                },
                {
                    id: 4,
                    name: "Lamination Film - 5mil",
                    description: "5mil gloss lamination film",
                    sku: "LAM-001",
                    price: 0.75,
                    cost_price: 0.35,
                    unit: "sqft"
                },
                {
                    id: 5,
                    name: "Card Stock - 100lb",
                    description: "100lb white card stock",
                    sku: "CARD-001",
                    price: 0.50,
                    cost_price: 0.30,
                    unit: "sheet"
                }
            ];
            
            console.log("Created sample materials:", materials.length);
            
            // Hide loading indicators - do this BEFORE adding materials to avoid display issues
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
                console.log("Hidden spinner");
            }
            if (loadingText) {
                loadingText.style.display = 'none';
                console.log("Hidden loading text");
            }
            
            if (materials.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No materials found. Create some materials first.</p>';
                return;
            }
            
            // Create a list item for each material
            materials.forEach(material => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action';
                
                // Create content with material details
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">${material.name}</h5>
                        <small class="text-primary">$${material.price.toFixed(2)} per ${material.unit}</small>
                    </div>
                    <p class="mb-1">${material.description || ''}</p>
                    <small>SKU: ${material.sku || 'N/A'}</small>
                `;
                
                // Add click handler to select this material
                item.addEventListener('click', function() {
                    addExistingMaterial(material);
                });
                
                container.appendChild(item);
            });
            
            console.log("Added material items to container:", materials.length);
        }
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">Edit Price</h1>
        <a href="{{ url_for('saved_prices_index') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Prices
        </a>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Price Details</h6>
        </div>
        <div class="card-body">
            <form method="post" action="{{ url_for('saved_prices_edit', id=saved_price.id) }}">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ saved_price.name }}" required>
                            <div class="form-text">Enter a descriptive name (e.g., "Premium Glossy Paper", "Business Card Print")</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="" disabled>Select a category</option>
                                <option value="paper" {% if saved_price.category == 'paper' %}selected{% endif %}>Paper</option>
                                <option value="print_job" {% if saved_price.category == 'print_job' %}selected{% endif %}>Print Job</option>
                                <option value="material" {% if saved_price.category == 'material' %}selected{% endif %}>Material</option>
                                <option value="labor" {% if saved_price.category == 'labor' %}selected{% endif %}>Labor</option>
                                <option value="other" {% if saved_price.category == 'other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="sku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="sku" name="sku" value="{{ saved_price.sku or '' }}">
                            <div class="form-text">Stock Keeping Unit (optional)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="unit" class="form-label">Unit <span class="text-danger">*</span></label>
                            <select class="form-select" id="unit" name="unit" required>
                                <option value="each" {% if saved_price.unit == 'each' %}selected{% endif %}>Each</option>
                                <option value="sheet" {% if saved_price.unit == 'sheet' %}selected{% endif %}>Sheet</option>
                                <option value="sqft" {% if saved_price.unit == 'sqft' %}selected{% endif %}>Square Foot</option>
                                <option value="hour" {% if saved_price.unit == 'hour' %}selected{% endif %}>Hour</option>
                                <option value="pack" {% if saved_price.unit == 'pack' %}selected{% endif %}>Pack</option>
                                <option value="box" {% if saved_price.unit == 'box' %}selected{% endif %}>Box</option>
                                <option value="roll" {% if saved_price.unit == 'roll' %}selected{% endif %}>Roll</option>
                                <option value="yard" {% if saved_price.unit == 'yard' %}selected{% endif %}>Yard</option>
                                <option value="meter" {% if saved_price.unit == 'meter' %}selected{% endif %}>Meter</option>
                                <option value="liter" {% if saved_price.unit == 'liter' %}selected{% endif %}>Liter</option>
                                <option value="gallon" {% if saved_price.unit == 'gallon' %}selected{% endif %}>Gallon</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="cost_price" class="form-label">Cost Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="cost_price" name="cost_price" step="0.01" min="0" value="{{ saved_price.cost_price }}">
                            </div>
                            <div class="form-text">Your cost (what you pay)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="price" class="form-label">Retail Price <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" value="{{ saved_price.price }}" required>
                            </div>
                            <div class="form-text">Customer price (what they pay)</div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="3">{{ saved_price.description }}</textarea>
                    <div class="form-text">Optional description or additional details</div>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="is_template" name="is_template" value="1" {% if saved_price.is_template %}checked{% endif %}>
                    <label class="form-check-label" for="is_template">Make this a job template with materials</label>
                    <div class="form-text">Templates can include a list of materials needed to create this item</div>
                </div>
                
                <div id="materials_section" class="card mb-3 {% if not saved_price.is_template %}d-none{% endif %}">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Material Requirements</h6>
                    </div>
                    <div class="card-body">
                        <div class="materials-container">
                            <!-- Existing materials -->
                            {% if saved_price.materials %}
                                {% for material in saved_price.materials %}
                                <div class="material-row mb-3 pb-3 border-bottom">
                                    <input type="hidden" name="material_ids[]" value="{{ material.id }}">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <label class="form-label">Material Name <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" name="material_names[]" value="{{ material.material_name }}" placeholder="e.g., Premium Paper">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">Category</label>
                                                <select class="form-select" name="material_categories[]">
                                                    <option value="paper" {% if material.category == 'paper' %}selected{% endif %}>Paper</option>
                                                    <option value="ink" {% if material.category == 'ink' %}selected{% endif %}>Ink</option>
                                                    <option value="substrate" {% if material.category == 'substrate' %}selected{% endif %}>Substrate</option>
                                                    <option value="laminate" {% if material.category == 'laminate' %}selected{% endif %}>Laminate</option>
                                                    <option value="binding" {% if material.category == 'binding' %}selected{% endif %}>Binding</option>
                                                    <option value="other" {% if material.category == 'other' or not material.category %}selected{% endif %}>Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" name="material_quantities[]" min="0" step="0.01" value="{{ material.quantity }}">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">Unit</label>
                                                <select class="form-select" name="material_units[]">
                                                    <option value="pcs" {% if material.unit == 'pcs' %}selected{% endif %}>Piece(s)</option>
                                                    <option value="sheets" {% if material.unit == 'sheets' %}selected{% endif %}>Sheet(s)</option>
                                                    <option value="sqft" {% if material.unit == 'sqft' %}selected{% endif %}>Sq. Foot</option>
                                                    <option value="yards" {% if material.unit == 'yards' %}selected{% endif %}>Yard(s)</option>
                                                    <option value="meters" {% if material.unit == 'meters' %}selected{% endif %}>Meter(s)</option>
                                                    <option value="liters" {% if material.unit == 'liters' %}selected{% endif %}>Liter(s)</option>
                                                    <option value="gallons" {% if material.unit == 'gallons' %}selected{% endif %}>Gallon(s)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <label class="form-label">Cost Price</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control" name="material_costs[]" min="0" step="0.01" value="{{ material.cost_price }}">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-1">
                                            <div class="mb-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-danger d-block remove-material">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-2">
                                                <label class="form-label">Notes</label>
                                                <textarea class="form-control" name="material_notes[]" rows="1" placeholder="Optional notes about this material">{{ material.notes }}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <!-- Initial empty material row if no existing materials -->
                                <div class="material-row mb-3 pb-3 border-bottom">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <label class="form-label">Material Name <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" name="material_names[]" placeholder="e.g., Premium Paper">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">Category</label>
                                                <select class="form-select" name="material_categories[]">
                                                    <option value="paper">Paper</option>
                                                    <option value="ink">Ink</option>
                                                    <option value="substrate">Substrate</option>
                                                    <option value="laminate">Laminate</option>
                                                    <option value="binding">Binding</option>
                                                    <option value="other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">Quantity <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" name="material_quantities[]" min="0" step="0.01" value="1">
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-2">
                                                <label class="form-label">Unit</label>
                                                <select class="form-select" name="material_units[]">
                                                    <option value="pcs">Piece(s)</option>
                                                    <option value="sheets">Sheet(s)</option>
                                                    <option value="sqft">Sq. Foot</option>
                                                    <option value="yards">Yard(s)</option>
                                                    <option value="meters">Meter(s)</option>
                                                    <option value="liters">Liter(s)</option>
                                                    <option value="gallons">Gallon(s)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <label class="form-label">Cost Price</label>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" class="form-control" name="material_costs[]" min="0" step="0.01" value="0.00">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-1">
                                            <div class="mb-2">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-danger d-block remove-material">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-2">
                                                <label class="form-label">Notes</label>
                                                <textarea class="form-control" name="material_notes[]" rows="1" placeholder="Optional notes about this material"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- No dynamic buttons needed with static form -->
                        <div class="text-center mt-4">
                            <div class="row justify-content-center mb-3">
                                <div class="col-md-12 alert alert-info">
                                    <p class="mb-0">You can have up to 3 materials for this template. Only fill in the fields you need.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modal for selecting existing materials -->
                        <div class="modal fade" id="existingMaterialsModal" tabindex="-1" aria-labelledby="existingMaterialsModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="existingMaterialsModalLabel">Select Existing Material</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="materialSearchInput" placeholder="Search materials...">
                                        </div>
                                        <div class="materials-list">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <p class="text-center text-muted">Loading materials...</p>
                                            <div id="materialsListContainer" class="list-group">
                                                <!-- Materials will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="reset" class="btn btn-outline-secondary">Reset</button>
                    <button type="submit" class="btn btn-primary">Update Price</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}